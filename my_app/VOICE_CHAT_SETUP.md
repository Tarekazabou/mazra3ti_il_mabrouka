# Voice Chat Setup Guide (LiveKit + Gemini)

This guide explains how to set up the LiveKit + Gemini voice chat integration for the vegetation display widget.

## Overview

The voice chat feature allows farmers to interact with an AI agricultural assistant in Arabic through voice. The system uses:

- **LiveKit**: For real-time audio communication
- **Gemini AI**: For natural language understanding and response generation
- **Arabic Language**: All interactions are in Arabic only

## Prerequisites

### 1. Gemini API Key

1. Go to [Google AI Studio](https://makersuite.google.com/app/apikey)
2. Sign in with your Google account
3. Create a new API key
4. Copy the API key (you'll need it later)

**Note**: The Gemini API has a free tier with limitations. For production use, consider upgrading to a paid plan.

### 2. LiveKit Server

You have two options:

#### Option A: LiveKit Cloud (Recommended for beginners)

1. Sign up at [LiveKit Cloud](https://cloud.livekit.io)
2. Create a new project
3. Note your project URL (e.g., `wss://your-project.livekit.cloud`)
4. Generate an API key and secret from the project settings

#### Option B: Self-hosted LiveKit

1. Follow [LiveKit Server Installation](https://docs.livekit.io/oss/deployment/)
2. Set up your server with SSL/TLS
3. Note your server URL (e.g., `wss://your-server.com`)

### 3. Generate LiveKit Token

LiveKit requires authentication tokens. You can generate them:

#### Using LiveKit CLI:

```bash
# Install LiveKit CLI
npm install -g @livekit/cli

# Generate a token
livekit-cli token create \
  --api-key YOUR_API_KEY \
  --api-secret YOUR_API_SECRET \
  --join --room farm-voice-assistant \
  --identity farmer-user \
  --valid-for 24h
```

#### Using Python (for backend integration):

```python
from livekit import api
import os

# Get credentials
api_key = os.getenv('LIVEKIT_API_KEY')
api_secret = os.getenv('LIVEKIT_API_SECRET')

# Create token
token = api.AccessToken(api_key, api_secret) \
    .with_identity("farmer-user") \
    .with_name("Farmer") \
    .with_grants(api.VideoGrants(
        room_join=True,
        room="farm-voice-assistant",
    )).to_jwt()

print(token)
```

**Important**: In production, tokens should be generated by your backend server, not hardcoded in the app.

## Configuration

### Method 1: Environment Variables (Recommended)

Set environment variables when building the app:

```bash
# For development
export GEMINI_API_KEY="your-gemini-api-key"
export LIVEKIT_URL="wss://your-livekit-server.com"
export LIVEKIT_TOKEN="your-livekit-token"

# Build with environment variables
flutter build apk --dart-define=GEMINI_API_KEY=$GEMINI_API_KEY \
                  --dart-define=LIVEKIT_URL=$LIVEKIT_URL \
                  --dart-define=LIVEKIT_TOKEN=$LIVEKIT_TOKEN
```

### Method 2: Update Configuration File

Edit `lib/voice_chat_config.dart` and replace the default values:

```dart
class VoiceChatConfig {
  static const String geminiApiKey = 'your-gemini-api-key-here';
  static const String livekitUrl = 'wss://your-livekit-server.com';
  static const String livekitToken = 'your-livekit-token-here';
  // ... rest of the file
}
```

**⚠️ Security Warning**: Never commit API keys to Git! Add `voice_chat_config.dart` to `.gitignore` if you hardcode values.

### Method 3: Backend Integration (Production Recommended)

For production apps, implement a backend service that:

1. Authenticates users
2. Generates LiveKit tokens on-demand
3. Stores API keys securely
4. Implements rate limiting

Example backend endpoint:

```python
from flask import Flask, jsonify
from livekit import api
import os

app = Flask(__name__)

@app.route('/api/voice-token', methods=['POST'])
def get_voice_token():
    # Authenticate user first
    user_id = authenticate_user()
    
    # Generate token
    api_key = os.getenv('LIVEKIT_API_KEY')
    api_secret = os.getenv('LIVEKIT_API_SECRET')
    
    token = api.AccessToken(api_key, api_secret) \
        .with_identity(user_id) \
        .with_grants(api.VideoGrants(
            room_join=True,
            room="farm-voice-assistant",
        )).to_jwt()
    
    return jsonify({
        'token': token,
        'url': os.getenv('LIVEKIT_URL')
    })
```

## Platform-Specific Setup

### Android

Permissions are already added to `android/app/src/main/AndroidManifest.xml`:

```xml
<uses-permission android:name="android.permission.INTERNET" />
<uses-permission android:name="android.permission.RECORD_AUDIO" />
<uses-permission android:name="android.permission.MODIFY_AUDIO_SETTINGS" />
<uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />
<uses-permission android:name="android.permission.CAMERA" />
<uses-permission android:name="android.permission.BLUETOOTH" />
<uses-permission android:name="android.permission.BLUETOOTH_CONNECT" />
```

### iOS

Permissions are already added to `ios/Runner/Info.plist`:

```xml
<key>NSMicrophoneUsageDescription</key>
<string>نحتاج إلى الوصول إلى الميكروفون للمحادثة الصوتية مع المساعد الزراعي</string>
<key>NSCameraUsageDescription</key>
<string>نحتاج إلى الكاميرا لمشاركة الفيديو في المحادثة</string>
```

## Testing

### 1. Test Configuration

```dart
import 'package:my_app/voice_chat_config.dart';

void main() {
  print('Configuration status: ${VoiceChatConfig.getConfigStatusMessage()}');
  print('Is configured: ${VoiceChatConfig.isConfigured()}');
}
```

### 2. Test Gemini API

```bash
curl -H 'Content-Type: application/json' \
     -d '{"contents":[{"parts":[{"text":"مرحبا"}]}]}' \
     -X POST 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=YOUR_API_KEY'
```

### 3. Test LiveKit Connection

Use the LiveKit client to test your server:

```bash
# Test connection
livekit-cli join-room \
  --url YOUR_LIVEKIT_URL \
  --token YOUR_TOKEN \
  --room farm-voice-assistant
```

## Usage in the App

1. Open the app and navigate to the vegetation display screen
2. Scroll to the voice chat section
3. Tap "بدء المحادثة الصوتية" (Start Voice Chat)
4. Grant microphone permission when prompted
5. Wait for connection (status should show "متصل")
6. Tap the test button to try a sample conversation
7. The AI will respond in Arabic about your farm's vegetation

## Troubleshooting

### "يرجى تكوين: Gemini API Key"

**Problem**: Gemini API key is not configured.

**Solution**: 
- Set the `GEMINI_API_KEY` environment variable
- Or update `voice_chat_config.dart` with your API key

### "فشل الاتصال: Connection failed"

**Problem**: Cannot connect to LiveKit server.

**Solution**:
- Check your LiveKit URL is correct
- Verify the token is valid and not expired
- Check internet connection
- Ensure LiveKit server is running

### "يجب السماح باستخدام الميكروفون"

**Problem**: Microphone permission denied.

**Solution**:
- Go to app settings and enable microphone permission
- Uninstall and reinstall the app to reset permissions

### Rate Limit Errors

**Problem**: Too many API calls to Gemini.

**Solution**:
- The free tier has limits (60 requests per minute)
- Implement rate limiting in your app
- Upgrade to a paid Gemini API plan

### Token Expired

**Problem**: LiveKit token is expired.

**Solution**:
- Tokens have expiration times (default 24 hours)
- Implement token refresh in your backend
- Generate new tokens programmatically

## Production Checklist

- [ ] Store API keys in secure backend, not in app
- [ ] Implement token generation endpoint in backend
- [ ] Add user authentication before allowing voice chat
- [ ] Set up monitoring for API usage and costs
- [ ] Implement rate limiting
- [ ] Add error tracking (e.g., Sentry)
- [ ] Test on real devices (Android and iOS)
- [ ] Implement offline mode or fallback
- [ ] Add analytics for voice chat usage
- [ ] Document for end users in Arabic

## Cost Considerations

### Gemini API

- Free tier: 60 requests per minute, 1500 requests per day
- Paid tier: Pay per 1000 characters
- See [Gemini Pricing](https://ai.google.dev/pricing)

### LiveKit

- Cloud free tier: 50 GB bandwidth per month
- Cloud paid tier: Pay per usage
- Self-hosted: Server costs only
- See [LiveKit Pricing](https://livekit.io/pricing)

## Security Best Practices

1. **Never commit secrets**: Add sensitive files to `.gitignore`
2. **Use backend for tokens**: Generate LiveKit tokens server-side
3. **Validate users**: Authenticate before allowing voice chat
4. **Rate limit**: Prevent API abuse
5. **Monitor usage**: Track API calls and costs
6. **Rotate keys**: Regularly update API keys
7. **Use HTTPS**: Always use secure connections
8. **Audit logs**: Log voice chat sessions for debugging

## Resources

- [LiveKit Documentation](https://docs.livekit.io/)
- [Gemini API Documentation](https://ai.google.dev/docs)
- [Flutter Permission Handler](https://pub.dev/packages/permission_handler)
- [LiveKit Flutter SDK](https://pub.dev/packages/livekit_client)

## Support

If you encounter issues:

1. Check the logs: `flutter logs`
2. Verify configuration: `VoiceChatConfig.isConfigured()`
3. Test individual components (Gemini, LiveKit) separately
4. Check GitHub issues for similar problems
5. Contact support with:
   - Error messages
   - Configuration (without exposing secrets)
   - Platform (Android/iOS)
   - Flutter version

## Next Steps

- Implement speech-to-text for better voice recognition
- Add text-to-speech for voice responses
- Create a dedicated voice chat screen
- Add conversation history
- Implement voice commands for farm control
- Add multi-language support (French, English)
- Integrate with backend for persistent chat history
